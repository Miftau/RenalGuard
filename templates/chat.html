{% extends "base.html" %}
{% block content %}
<section class="max-w-4xl mx-auto my-12 px-4">
  <div class="bg-gradient-to-br from-blue-50 to-indigo-100 rounded-2xl shadow-xl overflow-hidden">
    <!-- Header -->
    <div class="bg-gradient-to-r from-blue-600 to-indigo-700 p-6 text-center">
      <h2 class="text-2xl font-bold text-white flex items-center justify-center gap-2">
        <span class="bg-white bg-opacity-20 p-2 rounded-full">ðŸ’¬</span>
        Chat with RenalConsult AI
      </h2>
      <p class="text-blue-100 mt-2">Your personal kidney health assistant</p>
    </div>

    <!-- Chat Container -->
    <div class="p-6">
      <div id="chat-box" class="h-96 overflow-y-auto border border-gray-200 rounded-xl p-4 bg-gradient-to-b from-gray-50 to-white mb-4">
        {% for msg in history %}
          {% if msg.role == 'user' %}
            <div class="flex justify-end mb-4">
              <div class="max-w-[80%]">
                <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-4 py-3 rounded-2xl rounded-br-none">
                  {{ msg.content }}
                </div>
                <div class="text-xs text-gray-500 mt-1 text-right">You</div>
              </div>
            </div>
          {% else %}
            <div class="flex justify-start mb-4">
              <div class="max-w-[80%]">
                <div class="bg-gradient-to-r from-gray-200 to-gray-300 text-gray-800 px-4 py-3 rounded-2xl rounded-bl-none">
                  {{ msg.content }}
                </div>
                <div class="text-xs text-gray-500 mt-1">RenalConsult AI</div>
              </div>
            </div>
          {% endif %}
        {% endfor %}
      </div>

      <!-- Input Form -->
      <form id="chat-form" class="flex space-x-2">
        <input 
          id="message" 
          name="message" 
          class="flex-1 border border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 rounded-xl px-4 py-3 transition duration-200" 
          placeholder="Type your message or click the mic..." 
          autocomplete="off"
        >
        <button 
          type="button" 
          id="mic-button"
          class="bg-gradient-to-r from-indigo-500 to-indigo-600 text-white px-4 py-3 rounded-xl hover:from-indigo-600 hover:to-indigo-700 shadow-md hover:shadow-lg transition duration-300 transform hover:-translate-y-0.5"
          title="Start/Stop Voice Input"
        >
          ðŸŽ¤
        </button>
        <button 
          type="submit" 
          class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white px-6 py-3 rounded-xl hover:from-blue-700 hover:to-indigo-800 shadow-md hover:shadow-lg transition duration-300 transform hover:-translate-y-0.5"
        >
          Send
        </button>
      </form>

      <!-- Clear Chat Link -->
      <div class="text-center mt-4">
        <a href="{{ url_for('clear_chat') }}" class="inline-block text-sm text-gray-600 hover:text-blue-700 hover:underline transition duration-200">
          Clear Chat History
        </a>
      </div>
    </div>
  </div>

  <!-- Hidden audio element for speech synthesis -->
  <audio id="audio-player" style="display: none;"></audio>
</section>

<script>
const form = document.getElementById("chat-form");
const chatBox = document.getElementById("chat-box");
const input = document.getElementById("message");
const micButton = document.getElementById("mic-button");
const audioPlayer = document.getElementById("audio-player"); // For speech output

let recognition; // Variable to hold the SpeechRecognition instance
let isListening = false; // Flag to track recording state

// Check for browser support
if ('webkitSpeechRecognition' in window) {
  recognition = new webkitSpeechRecognition(); // Use webkit prefix for broader support
  recognition.continuous = false; // Stop after user stops talking
  recognition.interimResults = false; // Only return final results
  recognition.lang = 'en-US'; // Set language

  recognition.onresult = function(event) {
    const transcript = event.results[0][0].transcript;
    input.value = transcript; // Fill the input field with the recognized text
    // Optionally, submit the form immediately after recognition
    // form.dispatchEvent(new Event('submit'));
  };

  recognition.onend = function() {
    isListening = false;
    micButton.textContent = 'ðŸŽ¤'; // Reset mic button text
    micButton.classList.remove('bg-red-500', 'hover:bg-red-600');
    micButton.classList.add('bg-gradient-to-r', 'from-indigo-500', 'to-indigo-600', 'hover:from-indigo-600', 'hover:to-indigo-700');
  };

  recognition.onerror = function(event) {
    console.error('Speech recognition error:', event.error);
    isListening = false;
    micButton.textContent = 'ðŸŽ¤'; // Reset mic button text
    micButton.classList.remove('bg-red-500', 'hover:bg-red-600');
    micButton.classList.add('bg-gradient-to-r', 'from-indigo-500', 'to-indigo-600', 'hover:from-indigo-600', 'hover:to-indigo-700');
    // Optionally add an error message to the chat
    chatBox.innerHTML += `
      <div class="flex justify-start text-red-500 mb-4">
        <div class="max-w-[80%]">
          <div class="bg-gradient-to-r from-gray-200 to-gray-300 text-gray-800 px-4 py-3 rounded-2xl rounded-bl-none">
            Error: ${event.error}. Please try typing your message.
          </div>
          <div class="text-xs text-gray-500 mt-1">System</div>
        </div>
      </div>`;
    chatBox.scrollTop = chatBox.scrollHeight;
  };
} else {
  console.warn('Web Speech API is not supported in this browser.');
  // Disable the microphone button if not supported
  micButton.disabled = true;
  micButton.title = 'Speech Recognition not supported';
  micButton.classList.add('opacity-50', 'cursor-not-allowed');
}

// Function to start/stop speech recognition
function toggleSpeechRecognition() {
  if (isListening) {
    recognition.stop();
  } else {
    recognition.start();
    isListening = true;
    micButton.textContent = 'ðŸ”´'; // Change button text to indicate recording
    micButton.classList.remove('bg-gradient-to-r', 'from-indigo-500', 'to-indigo-600', 'hover:from-indigo-600', 'hover:to-indigo-700');
    micButton.classList.add('bg-red-500', 'hover:bg-red-600');
  }
}

// Event listener for the microphone button
micButton.addEventListener('click', toggleSpeechRecognition);

// Event listener for the submit button (or Enter key in the input)
form.addEventListener("submit", async (e) => {
  e.preventDefault();
  const message = input.value.trim();
  if (!message) return;

  // Add user message to chat
  chatBox.innerHTML += `
    <div class="flex justify-end mb-4">
      <div class="max-w-[80%]">
        <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-4 py-3 rounded-2xl rounded-br-none">
          ${message}
        </div>
        <div class="text-xs text-gray-500 mt-1 text-right">You</div>
      </div>
    </div>`;

  input.value = "";
  chatBox.scrollTop = chatBox.scrollHeight;

  // Show typing indicator
  const typingIndicator = document.createElement('div');
  typingIndicator.id = 'typing-indicator';
  typingIndicator.className = 'flex justify-start mb-4';
  typingIndicator.innerHTML = `
    <div class="max-w-[80%]">
      <div class="bg-gradient-to-r from-gray-200 to-gray-300 text-gray-800 px-4 py-3 rounded-2xl rounded-bl-none">
        <div class="flex space-x-1">
          <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce"></div>
          <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
          <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
        </div>
      </div>
      <div class="text-xs text-gray-500 mt-1">RenalConsult AI</div>
    </div>`;
  chatBox.appendChild(typingIndicator);
  chatBox.scrollTop = chatBox.scrollHeight;

  try {
    const response = await fetch("/chat", { // Assuming your Flask route is still /chat
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message }),
    });

    // Remove typing indicator
    const typingEl = document.getElementById('typing-indicator');
    if (typingEl) typingEl.remove();

    const data = await response.json();
    if (data.reply) {
      chatBox.innerHTML += `
        <div class="flex justify-start mb-4">
          <div class="max-w-[80%]">
            <div class="bg-gradient-to-r from-gray-200 to-gray-300 text-gray-800 px-4 py-3 rounded-2xl rounded-bl-none">
              ${data.reply}
            </div>
            <div class="text-xs text-gray-500 mt-1">RenalConsult AI</div>
          </div>
        </div>`;
      
      // --- NEW: Speak the AI's reply ---
      if ('speechSynthesis' in window) {
          const utterance = new SpeechSynthesisUtterance(data.reply);
          // Optional: Customize voice, rate, pitch
          // utterance.voice = speechSynthesis.getVoices().find(v => v.name === '...'); // Choose specific voice if needed
          utterance.rate = 1.0; // Default speed
          utterance.pitch = 1.0; // Default pitch
          utterance.volume = 1.0; // Default volume
          speechSynthesis.speak(utterance);
      } else {
          console.warn('Web Speech Synthesis API is not supported in this browser.');
      }
      // ---
    } else {
      chatBox.innerHTML += `
        <div class="flex justify-start text-red-500 mb-4">
          <div class="max-w-[80%]">
            <div class="bg-gradient-to-r from-gray-200 to-gray-300 text-gray-800 px-4 py-3 rounded-2xl rounded-bl-none">
              Error: ${data.error || "Unable to get response."}
            </div>
            <div class="text-xs text-gray-500 mt-1">RenalConsult AI</div>
          </div>
        </div>`;
    }
  } catch (error) {
    // Remove typing indicator
    const typingEl = document.getElementById('typing-indicator');
    if (typingEl) typingEl.remove();

    chatBox.innerHTML += `
      <div class="flex justify-start text-red-500 mb-4">
        <div class="max-w-[80%]">
          <div class="bg-gradient-to-r from-gray-200 to-gray-300 text-gray-800 px-4 py-3 rounded-2xl rounded-bl-none">
            Network error. Please try again.
          </div>
          <div class="text-xs text-gray-500 mt-1">RenalConsult AI</div>
        </div>
      </div>`;
  }

  chatBox.scrollTop = chatBox.scrollHeight;
});
</script>
{% endblock %}
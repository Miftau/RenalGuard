{% extends "base.html" %}
{% block title %}Book Appointment{% endblock %}
{% block content %}
<section class="py-8 bg-gradient-to-b from-gray-50 to-gray-100 min-h-screen">
  <div class="container mx-auto px-4 max-w-7xl">
    <!-- Header -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
      <div>
        <h1 class="text-3xl font-bold text-gray-800 flex items-center gap-3">
          <span class="bg-gradient-to-r from-red-500 to-red-700 p-2 rounded-lg text-white">üìÖ</span>
          Book an Appointment
        </h1>
        <p class="text-gray-600 mt-1">Select a date and time from available slots</p>
      </div>
      <a href="/user/dashboard" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-5 py-2.5 rounded-xl hover:from-gray-600 hover:to-gray-700 shadow-md hover:shadow-lg transition duration-300 text-center min-w-[120px]">
        Back to Dashboard
      </a>
    </div>

    <!-- Date Picker Card -->
    <div class="bg-white rounded-2xl shadow-lg p-6 mb-10 border border-gray-100">
      <h2 class="text-xl font-semibold mb-4 text-gray-800 flex items-center gap-2">
        <span class="bg-gradient-to-r from-red-500 to-red-700 p-1 rounded-lg text-white text-sm">üóìÔ∏è</span>
        Select Date
      </h2>
      <div class="flex items-center">
        <input
          id="calendarDate"
          type="date"
          class="border border-gray-300 rounded-xl p-3 w-full max-w-xs focus:outline-none focus:ring-2 focus:ring-red-400 shadow-sm"
          min="{{ now().date()|string }}" <!-- Ensure min date is today -->
        />
      </div>
    </div>

    <!-- Available Slots Section -->
    <div id="doctorsContainer" class="space-y-8">
      <!-- Dynamic doctor sections will be inserted here by JS -->
    </div>

    <!-- Confirmation Form (Initially Hidden) -->
    <div id="confirmationSection" class="hidden mt-12">
      <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-100">
        <h2 class="text-xl font-semibold mb-4 text-gray-800 flex items-center gap-2">
          <span class="bg-gradient-to-r from-red-500 to-red-700 p-1 rounded-lg text-white text-sm">‚úÖ</span>
          Confirm Your Booking
        </h2>
        <p class="text-gray-600 mb-4" id="confirmationText">You have selected a slot. Please confirm to proceed.</p>
        <!-- NEW: Hidden input for meeting URL (generated on backend) -->
        <input type="hidden" name="meeting_url" id="meetingUrlInput">
        <form method="POST" id="bookForm">
          <input type="hidden" name="slot_id" id="selectedSlotId">
          <div class="flex gap-4">
            <button
              type="submit"
              class="bg-gradient-to-r from-green-500 to-green-600 text-white px-6 py-3 rounded-xl hover:from-green-600 hover:to-green-700 shadow-md hover:shadow-lg transition duration-300"
            >
              Confirm Appointment
            </button>
            <button
              type="button"
              id="cancelBooking"
              class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-6 py-3 rounded-xl hover:from-gray-600 hover:to-gray-700 shadow-md hover:shadow-lg transition duration-300"
            >
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</section>

<script>
  // Data passed from the backend
  const allSlots = {{ slots|tojson }};
  const container = document.getElementById("doctorsContainer");
  const calendar = document.getElementById("calendarDate");
  const confirmationSection = document.getElementById("confirmationSection");
  const bookForm = document.getElementById("bookForm");
  const selectedSlotId = document.getElementById("selectedSlotId");
  const meetingUrlInput = document.getElementById("meetingUrlInput"); // NEW: Get the hidden meeting URL input
  const confirmationText = document.getElementById("confirmationText");
  const cancelBookingBtn = document.getElementById("cancelBooking");

  // --- Initialize: Show slots for today by default ---
  const today = new Date().toISOString().split('T')[0];
  calendar.value = today;
  renderSlotsByDate(today);

  // --- Render Slots by Date and Group by Doctor ---
  function renderSlotsByDate(date) {
    container.innerHTML = ""; // Clear previous content

    // Filter slots for the selected date
    const filtered = allSlots.filter(s => s.date === date);

    if (filtered.length === 0) {
      container.innerHTML = `
        <div class="text-center py-12 bg-white rounded-2xl shadow-lg p-6 border border-gray-100">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m4 4V3m4 4V3m2 8a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <p class="text-gray-600">No available slots for ${date}.</p>
          <p class="text-gray-500 text-sm mt-2">Please select another date.</p>
        </div>
      `;
      confirmationSection.classList.add("hidden"); // Hide confirmation if no slots
      return;
    }

    // Group slots by doctor ID
    const doctors = {};
    filtered.forEach(s => {
      if (!doctors[s.doctor_id]) {
        doctors[s.doctor_id] = {
          doctor: s.doctor,
          slots: []
        };
      }
      doctors[s.doctor_id].slots.push(s);
    });

    // Render each doctor's card
    for (const [doctorId, data] of Object.entries(doctors)) {
      const card = document.createElement("div");
      card.className = "bg-white rounded-2xl shadow-lg p-6 border border-gray-100 transition-all duration-300 hover:shadow-xl";

      // Create slot buttons HTML
      const slotsHTML = data.slots.map(s => `
        <button
          class="slot-btn bg-gradient-to-r from-blue-50 to-blue-100 border border-blue-200 text-blue-700 px-4 py-2 rounded-xl hover:from-blue-100 hover:to-blue-200 hover:border-blue-300 hover:text-blue-800 transition duration-200 shadow-sm"
          data-id="${s.id}"
          data-time="${s.start} - ${s.end}"
          data-doctor="${data.doctor}"
        >
          ${s.start} - ${s.end}
        </button>
      `).join("");

      card.innerHTML = `
        <div class="flex items-center mb-4">
          <div class="w-12 h-12 bg-gradient-to-r from-red-100 to-red-200 text-red-700 rounded-xl flex items-center justify-center font-bold text-lg">
            ${data.doctor[0].toUpperCase()}
          </div>
          <div class="ml-4">
            <h3 class="text-lg font-bold text-gray-800">Dr. ${data.doctor}</h3>
            <p class="text-gray-600 text-sm">Cardiology Specialist</p>
          </div>
        </div>
        <div class="border-t border-gray-200 pt-4">
          <h4 class="font-semibold text-gray-700 mb-3">Available Time Slots:</h4>
          <div class="flex flex-wrap gap-3" id="slots-${doctorId}">
            ${slotsHTML}
          </div>
        </div>
      `;

      container.appendChild(card);
    }

    // Attach event listeners to the newly created slot buttons
    attachSlotEvents();
  }

  // --- Handle Slot Selection ---
  function attachSlotEvents() {
    document.querySelectorAll(".slot-btn").forEach(btn => {
      btn.addEventListener("click", e => {
        e.preventDefault();
        // Deselect any previously selected slot
        document.querySelectorAll(".slot-btn").forEach(b => {
          b.classList.remove("bg-gradient-to-r", "from-green-100", "to-green-200", "border-green-400", "text-green-800");
          b.classList.add("bg-gradient-to-r", "from-blue-50", "to-blue-100", "border-blue-200", "text-blue-700");
        });

        // Select the clicked slot
        btn.classList.remove("bg-gradient-to-r", "from-blue-50", "to-blue-100", "border-blue-200", "text-blue-700");
        btn.classList.add("bg-gradient-to-r", "from-green-100", "to-green-200", "border-green-400", "text-green-800");

        // Update the hidden form field with the selected slot ID
        selectedSlotId.value = btn.getAttribute("data-id");

        // NEW: Clear the meeting URL input when a new slot is selected
        meetingUrlInput.value = "";

        // Update confirmation text
        const selectedTime = btn.getAttribute("data-time");
        const selectedDoctor = btn.getAttribute("data-doctor");
        confirmationText.textContent = `You have selected an appointment with Dr. ${selectedDoctor} at ${selectedTime} on ${calendar.value}. Please confirm to proceed.`;

        // Show the confirmation section
        confirmationSection.classList.remove("hidden");

        // Scroll to the confirmation section
        confirmationSection.scrollIntoView({ behavior: "smooth" });
      });
    });
  }

  // --- Calendar Listener ---
  calendar.addEventListener("change", e => {
    renderSlotsByDate(e.target.value);
    confirmationSection.classList.add("hidden"); // Hide confirmation when date changes
  });

  // --- Cancel Booking Listener ---
  cancelBookingBtn.addEventListener("click", e => {
      e.preventDefault();
      // Deselect any selected slot button
      document.querySelectorAll(".slot-btn").forEach(b => {
        b.classList.remove("bg-gradient-to-r", "from-green-100", "to-green-200", "border-green-400", "text-green-800");
        b.classList.add("bg-gradient-to-r", "from-blue-50", "to-blue-100", "border-blue-200", "text-blue-700");
      });
      // Clear the selected slot ID
      selectedSlotId.value = "";
      // NEW: Clear the meeting URL input when cancelled
      meetingUrlInput.value = "";
      // Hide the confirmation section
      confirmationSection.classList.add("hidden");
  });

  // --- Form Submission Listener ---
  bookForm.addEventListener("submit", e => {
      // The meeting URL is generated on the backend in app.py during the booking process.
      // This hidden field is prepared here but the value will be set by the backend after successful booking.
      // It's included in the form submission for potential future use or logging if needed,
      // but the actual URL generation happens server-side.
      // No client-side action needed here regarding the meeting URL itself.
      // The form will submit to the /book endpoint as defined in app.py.
  });

</script>
{% endblock %}
